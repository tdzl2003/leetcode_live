# 参考资料

[Penny的游戏：题目及John Conway的胜率公式](http://www.matrix67.com/blog/archives/6015)

[关于公式的一种使用母函数的证明（并且是更通用的形式）](https://www.sciencedirect.com/science/article/pii/0097316581900054)

其他（编程）解法：

* 在DFA上构建线性转移方程
* 在马尔科夫链上构建线性转移方程

# 胜率公式

记 $L(a,b)$ 为一个二进制数，其第 $i$ 位表示 $a$ 的前 $i$ 个字符是否和 $b$ 的后 $i$ 个字符相等，那么获胜概率为：

$$
(L(b,b)-L(b,a)):(L(a,a)-L(a,b))
$$

## 证明

换一种记法，记 $L_x(a,b)$ 表示一关于 $x$ 的多项式，其 $i$ 次系数定义同 $L(a,b)$ ，显然有 $L(a,b)=L_2(a,b)$

设 $f(i)$ 表示每一局游戏中， $i$ 次投币之后仍无人胜利的序列数量，其对应母函数 $F(x)=\sum_{x=0}^{\infty}f(i)x^{-i}$ （注意这里母函数和常规定义不太一样，使用了负数次项，为了便于后续处理）

另外， $f_a(i), f_b(i)$ 分别表示每一局游戏中，第 $i$ 次投币后，恰好 $a, b$ 获胜的序列数量，对应母函数 $F_z(x), F_b(x)$

那么首先，如果第 $i$ 次无人获胜，那么第 $i+1$ 次投币后，要么继续无人获胜，要么其中之一获胜；并且长度为0的序列必定无人获胜：

$$
1+\frac{2F(x)}x = F(x)+F_a(x)+F_b(x) 
$$

另一个角度是，考虑 $a$ 的序列长度为$k$，在 $i$ 次操作时仍无人胜利，而在 接下来的 $k$ 次操作中出现了 $a$ 序列，此时有两种可能性： $a$ 当时获胜； 在这 $k$ 步操作中 $a$ 或 $b$ 获胜。我们换一种方法表述，这k步中至少有一个人胜利，我们可以枚举这期间最早出现的一个匹配串（其中至少一个字符的后缀和序列 $a$ 的前缀重叠，因为 $i-k$ 步之前无人胜利）

下面的等式，左侧表示第 $i$ 次操作无人胜利，接下来 $k$ 次操作恰好出现了 $a$ 序列的所有情况；而等式右边则分别枚举了在这 $k$ 步中每个人胜利的所有情况，其胜利序列只会发生在至少一次操作后（所以乘以x），并且序列中有若干后缀和 $a$ 序列的前缀重叠，这部分由 $L_x$ 项来表达

$$
F(x) = xL_x(a,a)F_a(x) + xL_x(b,a)F_b(x)
$$

整理三个式子可以得到

$$
(x-2)F(x)+xF_a(x)+xF_b(x) = x \\
F(x)-xL_x(a,a)F_a(x)-xL_x(b,a)F_b(x) = 0 \\
F(x)-xL_x(a,b)F_a(x)-xL_x(b,b)F_b(x) = 0 \\
$$

解此线性方程组，可得到

$$
F(x) = \frac{x}{2-x}(1+F_a(x)+F_b(x)) \\
L_x(a,a)F_a(x) + L_x(b,a)F_b(x) = \frac{1}{1-x} \\
L_x(a,b)F_a(x) + L_x(b,b)F_b(x) = \frac{1}{1-x} \\
\frac{L_x(b,a)L_x(a,b)}{L_x(b,b)}F_a(x) + L_x(b,a)F_b(x) = \frac{L_x(b,a)}{(1-x)L_x(b,b)} \\

(L_x(a,a)-\frac{L_x(b,a)L_x(a,b)}{L_x(b,b)})F_a(x) = \frac{1}{1-x}(1-\frac{L_x(b,a)}{L_x(b,b)}) \\
(L_x(a,a)L_x(b,b)-L_x(b,a)L_x(a,b))F_a(x) = \frac{1}{1-x}(L_x(b,b)-L_x(b,a)) \\
F_a(x) = \frac{L_x(b,b)-L_x(b,a)}{(1-x)(L_x(a,a)L_x(b,b)-L_x(b,a)L_x(a,b))} \\
F_b(x) = \frac{L_x(a,a)-L_x(a,b)}{(1-x)(L_x(a,a)L_x(b,b)-L_x(b,a)L_x(a,b))}
$$

所以显然有 $F_a(x):F_b(x) = (L_x(b,b)-L_x(b,a)):(L_x(a,a)-L_x(a,b)) $

可以代入 $x=2$ 以计算每个序列真实出现的概率， $F_a(2)、F_b(2)$ 分别为它们获胜的总概率；其比例就为 $(L(b,b)-L(b,a)):(L(a,a)-L(a,b))$