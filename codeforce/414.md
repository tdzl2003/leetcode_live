
## B

按题意进行DP模拟，采用（倍数替代分解质因数）的技巧，可以做到 $O(nk\lg{n})$ 的时间复杂度，足以通过本题。

下面来讲如何进一步优化时间复杂度。

* 观察DP的过程，我们会发现每次转移时，当 $b_{i-1}\mid b_i$ 时，产生贡献。
* 如果我们一次性考虑多步转移，会发现如下结论：
    * 首先 $b_j \mid b_i$ 时 ( $j\lt i$ ) 产生贡献
    * 考虑 $d = \frac{b_i}{b_j}$ ，假设d的质因数分解为 $d=p_1^{a_1}p_2^{a_2}...$ ，可以看出，每一个质因数 $p_i$ 的 $a_i$ 个，可以分布在 $\frac{b_{j+1}}{b_j}$ 、 $\frac{b_{j+2}}{b_{j+1}}$ 这 $j-i$ 个桶中，并且不同质因数的分布独立。每个质因数的组合数即为（多重组合问题，请回忆八球问题） ${j-i+a_i-1 \choose a_i}$ 将其乘起即可。
    * 因此，我们可以直接枚举 $a_1，a_k$ （注意符合条件的仅有 $n\ln{n}$ 种组合），将其商分解质因数并求组合，复杂度为 $O(n\lg ^2{n} + k)$
* 更进一步的，我们可以在数列前面增加固定的 $a_0=1$ ，它不改变合法数列的数量，这样我们仅需要枚举 $a_k$ ，复杂度为 $O(nlgn + k)$
* 最后，我们可以进一步思考分解质因数的过程：
    * 我们采用埃筛或者欧筛获取质数表时，可以顺便获取每个数字的“最小质因数”
    * 假设 $j = \frac{i}{minPrime[i]}$ ，可以看出 $j$ 的质因子一定也同时是 $i$ 的质因子，因此分为两种情况：
        * $minPrime[i] \mid j$ ，此时 $i$ 中该质因子数量为 $j$ 中该质因子数量+1 ，且此时必有 $minPrime[j] = minPrime[i]$
        * $minPrime[i] \nmid j$ ，此时必有 $minPrime[j] \gt minPrime[i]$ ，因此该质因子数量为1
    * 因此，我们可以 $O(n)$ 迭代时，记录每个数“最小质因子的数量” ，而不关心其它质因子的数量。迭代时，如果引入了新的最小质因子，则结果在上次结果上乘以 ${k \choose 1} = k$ 。否则，设最小质因子指数为 $a$ ，则结果在上次结果上乘上 $\frac{(k+a-1)\choose a}{(k+a-2) \choose (a-1)} = \frac{k+a-1}{a}$
    * 该方法可以在 $O(n+k)$ 时间完成。

上述思路中，本质上是定义了一个积性函数 $f(p^a) = {k+a-1 \choose a}$ ，然后采用欧拉筛（线性筛法）在 $O(n)$ 时间求解。

> 采用杜教筛，有可能也可以在 $O(n^{2/3})$ 时间求解，待实验。


下面来解析一下[蛙神的约 $O(n^{2/3})$](https://leetcode.cn/problems/count-the-number-of-ideal-arrays/solution/ling-yi-chong-xian-xing-zuo-fa-by-hqztru-5w9f/) 解法。是按我自己理解翻译的，部分过程可能和蛙神的做法顺序不一样。

* 首先考虑答案数组中不同数字的个数，很显然不超过 $\lg{n}$ 个。我们枚举不同数字个数的情况 $l=1, 2, ... \lg{n}$ ，统计出图上长度为 $l$ 的路径数，其每一条路径对应的方案数为 ${k-1 \choose l}$ 。注意到这个组合数上面固定为k，下面也不超过 $\lg{n}$ ，其求解复杂度与 $k$ 无关，不超过 $\lg{n}$
* 注意到以不超过 $n$ 的点为起点，以 $i$ 为终点的路径，等于以不超过 $\lfloor\frac{n}{i}\rfloor$ 为起点，以1为终点的路径数（路径一一对应，有大量的起点不是 $i$ 的倍数是不存在路径的），但是路径长度+1。
* 选择一个参数d，预处理 d 以内为起点的路径数（复杂度 $O(d\lg{d}\lg{n})$ ），然后开始施展魔法：
    * 以 $\ge \frac{n}{d}$ 为终点的 $i$ ，我们可以直接求出对应的路径数。因为 $\lfloor\frac{n}{i}\rfloor\le d$ ，我们可以合并计算相同的 $\lfloor\frac{n}{i}\rfloor$，在 $O(d\lg{n})$ 时间内算完所有的组合数。
    * 以 $\lt \frac{n}{d}$ 为终点的 $i$：
        * 考虑下一项为 $ik$ ， $ik$ 虽然有很多种，但是 $\lfloor\frac{n}{ik}\rfloor$ 仅有 $O(\sqrt{\frac{n}{i}}) = O(\sqrt{d})$ 种取值，因此可以合并计算。
    * 这里终点可以理解为数列增加一项（之后所有项都乘以这个项）
* 因此选择 $d=n^{2/3}$ ，总复杂度为 $O(dlgdlgn + dlgn + \frac{n}{d}\sqrt{d}lgn) = O(n^{2/3}lg^2n)$ 

> 预处理部分现在多了一个lgn复杂度，不知道有没有办法去掉。

下面进行对杜教筛的尝试。前面我们已经得出积性函数：

$f(p^a) = {k+a-1 \choose a} = {k+a-1 \choose k-1}$

我们要寻找合适的函数 $g$ 使 $f\ast g$ 的前缀和和g的单点值易于求解

设 $f\ast g = 1$ 

```
g(1) = 1
g(2)*1 + g(1)*k = 1
g(2) = 1-k
g(3) = 1-k
g(4)*1 + (1-k)*k+(k*(k+1)/2) = 1
g(4) + k-k^2+0.5k^2+0.5k = 1
g(4) = 1 + 0.5k^2 - 1.5k = (1-0.5k)(1-k) = (1-k)(2-k)/2
g(6)*1 + (1-k)*k+(1-k)*k+g(1)*k^2 = 1
g(6) = 1 + k^2 - 2k = (1-k)^2
```

大胆假设 $g(p^a) = (-1)^a{k-1 \choose a} $ ，易见 $f\ast g=1$ 成立

初步验证成立

接下来用递推式 $g(1)S(n) = \sum_{i=1}^n(f\ast g)(i) - \sum_{i=2}^{n}g(i)S(\lfloor\frac{n}{i}\rfloor)$ 求解

该式简化后如下：

$$
S(n) = n - \sum_{i=2}^{n}g(i)S(\lfloor\frac{n}{i}\rfloor)
$$

为了实现分块求解，我们需要能够对一个区间计算 $\sum g(i)$ 或者计算 $S_g(i)$ 

> 在这里卡住了。
