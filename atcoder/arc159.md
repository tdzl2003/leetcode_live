[比赛链接](https://atcoder.jp/contests/arc159)

## A

考虑 $s'=s \bmod K, t'=t \bmod K $ ：

* 当 $s' \ne t'$ ，有 $dis(s,t) = dis(s',t')$
* 当 $s' = t'$ ， $dis(s,t)$ 等于 $s'$ 为起点的最小环长度。

因此对每个 $s'$ ，进行BFS，求出它到每个点的最短距离以及回到自己的最早时机即可。魔改这个BFS可以有两种办法：

* 单独处理BFS的第一步，使 $s'$ 的相邻点 $d=1$
* 或者单独处理BFS的最后一步，令 $dis(s',s')=\min_{a_{u,s'} = 1}dis(s', u)+1$

## B

数学题。

首先容易看出每次操作后，$g$ 或者不变，或者变为自己的一个倍数。因为 $g$ 变成自己倍数的次数有限（不超过 $\lg A$），所以，我们尽可能联合计算 $g$ 不变的操作次数。

将该步骤变形如下：设 $a = a'g, b=b'g$ ，此时有 $a', b'$ 互质，每次操作后， $a', b'$ 分别减一，直到 $a',b'$ 不再互质为止。

因此我们要找到最小的 $k$ ，满足 $gcd(a'-k, b'-k)>1$ 此时设 $gcd(a'-k,b'-k) = g'$ 。

并且我们注意到，对 $g'$ 的任何一个素因子 $p$ ，都有 $a' \bmod p \le k$ 。而如果 $a' \bmod p \lt k$ ，则与 $k$ 是最小的满足前述条件的值矛盾 ($a' \bmod p$ 是一个更小的满足条件的值） 所以有 $a' \bmod p = k$ 。因此我们仅需要考虑素数因子就能找到最小的 $k$ 

同时，显然有 $g'|((a'-k)-(b'-k))$ ， $g'|(a'-b')$， 所以 $g'$ 的素因子 一定同时也是 $a'-b'$ 的素因子。

因此构建每次迭代的算法如下：

* 计算出 $g$ ，然后求出 $a', b'$ 。
* 将 $a'-b'$ 分解质因数，对每一个质因数 $p$ 求出对应的 $a' \bmod p$ ，令其最小值为 $k$
* 累积答案加上 $k$ ， $a,b$ 减去 $g\times k$

每次迭代分解质因数的复杂度为 $O(\frac{\sqrt{A}}{\lg{A}})$ 总迭代次数不超过 $\lg{A}$ 次，总复杂度 $O(\sqrt{A})$

## C

构造题

注意到如下两组排列：

```
1,2,3,4,5
4,5,3,2,1
```

可以使 `a[0]` 相对减少1，使 `a[1]` 相对增加1，可利用该方法重复构造解。

我们还需找到无解的情况并证明。 注意到每次操作使总和增加了 $\frac{N(N+1)}{2}$ ，并且所有数相同的情况下所有数都会是 $N$ 的倍数，所以：

* 若 $N$ 为奇数 ，则总和必须为 $N$ 的倍数。
* 若 $N$ 为偶数 ，则总和必须为 $\frac{N}{2}$ 的倍数。

不满足上述条件时，可判定为无解。满足上述条件时：

* 若总和是 $N$ 的倍数，意味着所有数的平均数是一个整数，所有数减去平均数的总和为 $0$ ，总是可以通过前述操作完成。
* 若 $N$ 为偶数，且总和是 $\frac{N}{2}$ 的倍数而不是 $N$ 的倍数，此时可任意增加一次操作，使总和增加 $\frac{N(N+1)}{2}$ ，从而变成 $N$ 的倍数。

## D

动态规划转线段树问题。

先考虑值域的朴素DP，对序列里的每一个数，